# 分布式机群监管系统接口设计文档

> B/S架构的分布式设备监控与管理系统

## 接口概览

### 用户端接口

| 序号 | 接口描述 | 请求路径 | 请求方式 | 备注 |
| ---- | -------- | -------- | -------- | ---- |
| **认证授权** |
| 1.1 | 用户登录 | `/auth/login` | POST | 获取Token |
| 1.2 | 用户登出 | `/auth/logout` | POST | 退出登录 |
| 1.3 | 刷新Token | `/auth/refresh` | POST | 刷新访问令牌 |
| 1.4 | 获取当前用户信息 | `/auth/profile` | GET | 用户个人信息 |
| **设备管理** |
| 2.1 | 获取设备列表 | `/devices` | GET | 分页查询 |
| 2.2 | 获取设备详情 | `/devices/{id}` | GET | 单个设备详情 |
| 2.3 | 添加设备 | `/devices` | POST | 注册新设备 |
| 2.4 | 更新设备信息 | `/devices/{id}` | PUT | 更新设备 |
| 2.5 | 删除设备 | `/devices/{id}` | DELETE | 删除设备 |
| 2.6 | 获取设备分组 | `/devices/device-groups` | GET | 分组树形结构 |
| 2.7 | 获取设备统计 | `/devices/statistics` | GET | 在线/离线统计 |
| **设备配置** |
| 3.1 | 获取设备配置 | `/devices/{id}/config` | GET | 查看配置 |
| 3.2 | 更新设备配置 | `/devices/{id}/config` | PUT | 批量更新配置 |
| 3.3 | 同步配置到设备 | `/devices/{id}/config/sync` | POST | 推送配置 |
| **命令控制** |
| 4.1 | 获取命令列表 | `/devices/commands` | GET | 可用命令 |
| 4.2 | 发送控制命令 | `/devices/{id}/commands` | POST | 执行命令 |
| 4.3 | 查询命令执行状态 | `/devices/commands/logs/{id}` | GET | 命令执行结果 |
| 4.4 | 获取命令执行历史 | `/devices/{id}/commands/history` | GET | 历史记录 |
| **状态监控** |
| 5.1 | 获取设备实时状态 | `/devices/{id}/status` | GET | 当前状态 |
| 5.2 | 获取设备状态历史 | `/devices/{id}/status/history` | GET | 历史数据 |
| 5.3 | 获取设备心跳记录 | `/devices/{id}/heartbeat` | GET | 心跳历史 |
| **告警管理** |
| 6.1 | 获取告警列表 | `/alerts` | GET | 告警记录 |
| 6.2 | 获取告警详情 | `/alerts/{id}` | GET | 单条告警 |
| 6.3 | 确认告警 | `/alerts/{id}/confirm` | PUT | 确认处理 |
| 6.4 | 解决告警 | `/alerts/{id}/resolve` | PUT | 标记解决 |
| 6.5 | 忽略告警 | `/alerts/{id}/ignore` | PUT | 忽略告警 |
| 6.6 | 获取告警统计 | `/alerts/statistics` | GET | 统计数据 |
| **报表管理** |
| 7.1 | 获取报表配置列表 | `/reports/configs` | GET | 报表模板 |
| 7.2 | 生成报表 | `/reports/generate` | POST | 创建报表任务 |
| 7.3 | 获取报表生成记录 | `/reports/logs` | GET | 生成历史 |
| 7.4 | 下载报表 | `/reports/download/{id}` | GET | 下载文件 |
| **操作日志** |
| 8.1 | 获取操作日志 | `/logs/operations` | GET | 系统日志 |

### 管理端接口

| 序号 | 接口描述 | 请求路径 | 请求方式 | 备注 |
| ---- | -------- | -------- | -------- | ---- |
| **用户管理** |
| 9.1 | 管理端-获取用户列表 | `/admin/users` | GET | 用户管理 |
| 9.2 | 管理端-创建用户 | `/admin/users` | POST | 新增用户 |
| 9.3 | 管理端-更新用户 | `/admin/users/{id}` | PUT | 修改用户 |
| 9.4 | 管理端-删除用户 | `/admin/users/{id}` | DELETE | 删除用户 |
| 9.5 | 管理端-重置密码 | `/admin/users/{id}/reset-password` | PUT | 重置密码 |
| **角色权限** |
| 10.1 | 管理端-获取角色列表 | `/admin/roles` | GET | 角色列表 |
| 10.2 | 管理端-创建角色 | `/admin/roles` | POST | 新增角色 |
| 10.3 | 管理端-更新角色 | `/admin/roles/{id}` | PUT | 修改角色 |
| 10.4 | 管理端-删除角色 | `/admin/roles/{id}` | DELETE | 删除角色 |
| 10.5 | 管理端-分配权限 | `/admin/roles/{id}/permissions` | PUT | 角色授权 |
| 10.6 | 管理端-获取权限列表 | `/admin/permissions` | GET | 权限树 |
| **告警规则** |
| 11.1 | 管理端-获取告警规则 | `/admin/alert-rules` | GET | 规则列表 |
| 11.2 | 管理端-创建告警规则 | `/admin/alert-rules` | POST | 新增规则 |
| 11.3 | 管理端-更新告警规则 | `/admin/alert-rules/{id}` | PUT | 修改规则 |
| 11.4 | 管理端-删除告警规则 | `/admin/alert-rules/{id}` | DELETE | 删除规则 |
| **报表配置** |
| 12.1 | 管理端-获取报表配置 | `/admin/report-configs` | GET | 报表管理 |
| 12.2 | 管理端-创建报表配置 | `/admin/report-configs` | POST | 新增报表 |
| 12.3 | 管理端-更新报表配置 | `/admin/report-configs/{id}` | PUT | 修改报表 |
| 12.4 | 管理端-删除报表配置 | `/admin/report-configs/{id}` | DELETE | 删除报表 |

### 设备端接口（供分布式机器调用）

| 序号 | 接口描述 | 请求路径 | 请求方式 | 备注 |
| ---- | -------- | -------- | -------- | ---- |
| 13.0 | 设备认证登录 | `/device/auth/login` | POST | 获取设备Token（用于设备注册/离线场景） |
| 13.1 | 设备心跳（保留：注册/诊断） | `/device/heartbeat` | POST | 保活心跳（HTTP仅限注册/诊断，实时场景请使用WebSocket） |
| 13.2 | 上报设备状态（保留：注册/报表） | `/device/status` | POST | 状态上报（HTTP仅限注册/报表，实时上报必须使用WebSocket） |
| 13.3 | 获取待执行命令（已弃用 HTTP） | `/device/commands/pending` | GET | HTTP轮询已弃用，请使用WebSocket接收命令 |
| 13.4 | 上报命令执行结果（已弃用 HTTP） | `/device/commands/{id}/result` | PUT | 命令响应（请通过WebSocket上报） |
| 13.5 | 获取配置信息（保留：注册/报表） | `/device/config` | GET | 拉取配置（HTTP仅限注册/报表） |
| 13.6 | 确认配置同步（保留：注册/报表） | `/device/config/confirm` | POST | 同步确认（HTTP仅限注册/报表） |

**重要说明：**
- 设备身份识别：使用 `device_code`（设备编码）作为唯一标识，不依赖IP或端口。
- 设备认证：门禁设备应使用 `device_code` 与 `device_secret` 完成认证（WebSocket连接或认证消息）。
- HTTP用途限制：**门禁场景中，HTTP仅用于设备注册、离线上报或报表导出，不用于实时命令或实时状态上报。**
- 强制要求：门禁设备必须使用 WebSocket（`/device/ws`）建立长连接以实现实时双向通信（状态上报、命令接收、命令结果上报等）。

### WebSocket接口

| 序号 | 接口描述 | 连接路径 | 备注 |
| ---- | -------- | -------- | ---- |
| 14.1 | 实时监控WebSocket | `/ws/monitor` | 前端监控状态推送 |
| 14.2 | 告警推送WebSocket | `/ws/alerts` | 前端告警通知推送 |
| 14.3 | 设备WebSocket长连接 | `/device/ws` | 设备与服务器长连接（推荐） |

---

## 1. 认证授权接口

### 1.1 用户登录

#### 1.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/auth/login` |
| 请求方式 | `POST` |
| 接口描述 | 用户登录接口，返回JWT Token |
| 是否需要认证 | 否 |

#### 1.1.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| username | string | 必须 | admin | 用户名 |
| password | string | 必须 | admin123 | 密码 |

#### 1.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| accessToken | string | 必须 | 访问令牌 |
| refreshToken | string | 必须 | 刷新令牌 |
| tokenType | string | 必须 | 令牌类型（Bearer） |
| expiresIn | number | 必须 | 过期时间（秒） |
| userId | number | 必须 | 用户ID |
| username | string | 必须 | 用户名 |
| realName | string | 否 | 真实姓名 |
| isAdmin | boolean | 必须 | 是否管理员 |
| roles | string[] | 必须 | 角色列表 |
| permissions | string[] | 必须 | 权限列表 |

#### 1.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 7200,
    "userId": 1,
    "username": "admin",
    "realName": "系统管理员",
    "isAdmin": true,
    "roles": ["admin"],
    "permissions": ["system:*", "device:*", "monitor:*"]
  }
}
```

---

### 1.2 用户登出

#### 1.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/auth/logout` |
| 请求方式 | `POST` |
| 接口描述 | 用户登出，清除Token |
| 是否需要认证 | 是 |

#### 1.2.2 请求参数

无

#### 1.2.3 响应数据字段 (data: null)

无

#### 1.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "登出成功",
  "data": null
}
```

---

### 1.3 刷新Token

#### 1.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/auth/refresh` |
| 请求方式 | `POST` |
| 接口描述 | 使用刷新令牌获取新的访问令牌 |
| 是否需要认证 | 是（需要RefreshToken） |

#### 1.3.2 请求参数 (Header)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| Authorization | string | 必须 | Bearer {refreshToken} | 刷新令牌 |

#### 1.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| accessToken | string | 必须 | 新的访问令牌 |
| refreshToken | string | 必须 | 新的刷新令牌 |
| tokenType | string | 必须 | 令牌类型（Bearer） |
| expiresIn | number | 必须 | 过期时间（秒） |

#### 1.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "Token刷新成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 7200
  }
}
```

---

### 1.4 获取当前用户信息

#### 1.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/auth/profile` |
| 请求方式 | `GET` |
| 接口描述 | 获取当前登录用户的详细信息 |
| 是否需要认证 | 是 |

#### 1.4.2 请求参数

无

#### 1.4.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| userId | number | 必须 | 用户ID |
| username | string | 必须 | 用户名 |
| realName | string | 否 | 真实姓名 |
| email | string | 否 | 邮箱 |
| phone | string | 否 | 手机号 |
| avatarUrl | string | 否 | 头像URL |
| isAdmin | boolean | 必须 | 是否管理员 |
| roles | object[] | 必须 | 角色列表 |
| &nbsp;&nbsp;roleCode | string | 必须 | 角色编码 |
| &nbsp;&nbsp;roleName | string | 必须 | 角色名称 |
| permissions | string[] | 必须 | 权限编码列表 |

#### 1.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "系统管理员",
    "email": "admin@example.com",
    "phone": "13800138000",
    "avatarUrl": "https://example.com/avatar.jpg",
    "isAdmin": true,
    "roles": [
      {
        "roleCode": "admin",
        "roleName": "系统管理员"
      }
    ],
    "permissions": [
      "system:user:view",
      "system:user:add",
      "device:view",
      "device:control"
    ]
  }
}
```

---

## 2. 设备管理接口

### 2.1 获取设备列表

#### 2.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询设备列表，支持多条件筛选 |
| 是否需要认证 | 是 |

#### 2.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| keyword | string | 否 | 服务器01 | 关键词搜索（设备名称、编码） |
| groupId | number | 否 | 1 | 设备分组ID |
| deviceType | string | 否 | server | 设备类型 |
| status | string | 否 | online | 状态筛选：online/offline/fault/maintain |
| onlineStatus | number | 否 | 1 | 在线状态：0-离线 1-在线 |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 2.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 设备列表 |
| &nbsp;&nbsp;id | number | 必须 | 设备ID |
| &nbsp;&nbsp;deviceCode | string | 必须 | 设备编码 |
| &nbsp;&nbsp;deviceName | string | 必须 | 设备名称 |
| &nbsp;&nbsp;deviceType | string | 必须 | 设备类型 |
| &nbsp;&nbsp;groupId | number | 否 | 分组ID |
| &nbsp;&nbsp;groupName | string | 否 | 分组名称 |
| &nbsp;&nbsp;ipAddress | string | 否 | IP地址 |
| &nbsp;&nbsp;location | string | 否 | 物理位置 |
| &nbsp;&nbsp;status | string | 必须 | 设备状态 |
| &nbsp;&nbsp;onlineStatus | number | 必须 | 在线状态 |
| &nbsp;&nbsp;lastHeartbeatTime | string | 否 | 最后心跳时间 |
| &nbsp;&nbsp;registerTime | string | 否 | 注册时间 |

#### 2.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 25,
    "rows": [
      {
        "id": 1,
        "deviceCode": "DEV-001",
        "deviceName": "生产服务器01",
        "deviceType": "server",
        "groupId": 2,
        "groupName": "生产环境",
        "ipAddress": "192.168.1.100",
        "location": "机房A-01机柜",
        "status": "online",
        "onlineStatus": 1,
        "lastHeartbeatTime": "2025-12-11 10:30:00",
        "registerTime": "2025-01-01 00:00:00"
      },
      {
        "id": 2,
        "deviceCode": "DEV-002",
        "deviceName": "测试服务器01",
        "deviceType": "server",
        "groupId": 3,
        "groupName": "测试环境",
        "ipAddress": "192.168.1.101",
        "location": "机房A-02机柜",
        "status": "offline",
        "onlineStatus": 0,
        "lastHeartbeatTime": "2025-12-11 09:15:00",
        "registerTime": "2025-01-05 10:00:00"
      }
    ]
  }
}
```

---

### 2.2 获取设备详情

#### 2.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}` |
| 请求方式 | `GET` |
| 接口描述 | 获取单个设备的详细信息 |
| 是否需要认证 | 是 |

#### 2.2.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |

#### 2.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |
| deviceCode | string | 必须 | 设备编码 |
| deviceName | string | 必须 | 设备名称 |
| deviceType | string | 必须 | 设备类型 |
| groupId | number | 否 | 分组ID |
| groupName | string | 否 | 分组名称 |
| ipAddress | string | 否 | IP地址 |
| port | number | 否 | 端口号 |
| macAddress | string | 否 | MAC地址 |
| location | string | 否 | 物理位置 |
| description | string | 否 | 设备描述 |
| status | string | 必须 | 设备状态 |
| onlineStatus | number | 必须 | 在线状态 |
| lastHeartbeatTime | string | 否 | 最后心跳时间 |
| registerTime | string | 否 | 注册时间 |
| createdAt | string | 必须 | 创建时间 |
| updatedAt | string | 必须 | 更新时间 |
| currentStatus | object | 否 | 当前实时状态（门禁相关） |
| &nbsp;&nbsp;doorStatus | string | 否 | 门状态：open/closed |
| &nbsp;&nbsp;doorControllerStatus | string | 否 | 门禁控制器状态：normal/fault/... |

#### 2.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "id": 1,
    "deviceCode": "DEV-001",
    "deviceName": "生产服务器01",
    "deviceType": "server",
    "groupId": 2,
    "groupName": "生产环境",
    "ipAddress": "192.168.1.100",
    "port": 8080,
    "macAddress": "00:1A:2B:3C:4D:5E",
    "location": "机房A-01机柜",
    "description": "核心业务服务器",
    "status": "online",
    "onlineStatus": 1,
    "lastHeartbeatTime": "2025-12-11 10:30:00",
    "registerTime": "2025-01-01 00:00:00",
    "createdAt": "2025-01-01 00:00:00",
    "updatedAt": "2025-12-11 10:30:00",
    "currentStatus": {
      "cpuUsage": 45.6,
      "memoryUsage": 68.3,
      "diskUsage": 52.1,
      "temperature": 42.5
    }
  }
}
```

---

### 2.3 添加设备

#### 2.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices` |
| 请求方式 | `POST` |
| 接口描述 | 注册新设备到系统。系统会自动生成 `device_secret`（设备密钥）并返回，用于设备后续认证。**设备密钥仅在创建时返回一次，请立即保存** |
| 是否需要认证 | 是（需要设备添加权限） |

#### 2.3.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（唯一） |
| deviceName | string | 必须 | 服务器01 | 设备名称 |
| deviceType | string | 必须 | server | 设备类型 |
| groupId | number | 否 | 1 | 所属分组ID |
| ipAddress | string | 否 | 192.168.1.100 | IP地址 |
| port | number | 否 | 8080 | 端口号 |
| macAddress | string | 否 | 00:1A:2B:3C:4D:5E | MAC地址 |
| location | string | 否 | 机房A-01 | 物理位置 |
| description | string | 否 | 描述信息 | 设备描述 |

#### 2.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 新创建的设备ID |
| deviceCode | string | 必须 | 设备编码（唯一标识，不可修改） |
| deviceName | string | 必须 | 设备名称 |
| deviceSecret | string | 必须 | 设备密钥（系统自动生成，用于设备认证，请妥善保管） |
| createdAt | string | 必须 | 创建时间 |

**重要提示：**
- **设备注册流程**：管理员调用此接口注册设备后，系统会自动生成 `device_secret`（设备密钥）并返回
- **设备编码（`deviceCode`）**：是设备的唯一标识，不可修改，作为设备身份识别依据
- **设备密钥（`deviceSecret`）**：仅在创建设备时返回一次，请立即保存，用于所有设备端接口的认证
- **设备认证**：设备需要使用 `deviceCode` 和 `deviceSecret` 进行认证：
  - HTTP接口：在请求参数中提供 `deviceCode` 和 `deviceSecret`
  - WebSocket接口：在连接URL参数中提供 `deviceCode` 和 `deviceSecret`
- **IP地址和端口**：仅作为辅助信息，不作为设备标识（设备IP可能动态变化）
- **密钥丢失**：如果密钥丢失，需要通过重置密钥功能重新生成

#### 2.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "添加成功",
  "data": {
    "id": 26,
    "deviceCode": "DEV-026",
    "deviceName": "生产服务器26",
    "deviceSecret": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6",
    "createdAt": "2025-12-11 10:35:00"
  }
}
```

---

### 2.4 更新设备信息

#### 2.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}` |
| 请求方式 | `PUT` |
| 接口描述 | 更新设备的基本信息 |
| 是否需要认证 | 是（需要设备编辑权限） |

#### 2.4.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| deviceName | string | 否 | 服务器01 | 设备名称 |
| deviceType | string | 否 | server | 设备类型 |
| groupId | number | 否 | 1 | 所属分组ID |
| ipAddress | string | 否 | 192.168.1.100 | IP地址 |
| port | number | 否 | 8080 | 端口号 |
| macAddress | string | 否 | 00:1A:2B:3C:4D:5E | MAC地址 |
| location | string | 否 | 机房A-01 | 物理位置 |
| description | string | 否 | 描述信息 | 设备描述 |

#### 2.4.3 响应数据字段 (data: null)

无

#### 2.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "更新成功",
  "data": null
}
```

---

### 2.5 删除设备

#### 2.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}` |
| 请求方式 | `DELETE` |
| 接口描述 | 删除指定设备（级联删除相关数据） |
| 是否需要认证 | 是（需要设备删除权限） |

#### 2.5.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |

#### 2.5.3 响应数据字段 (data: null)

无

#### 2.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "删除成功",
  "data": null
}
```

---

### 2.6 获取设备分组

#### 2.6.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/device-groups` |
| 请求方式 | `GET` |
| 接口描述 | 获取设备分组树形结构 |
| 是否需要认证 | 是 |

#### 2.6.2 请求参数

无

#### 2.6.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 分组ID |
| groupName | string | 必须 | 分组名称 |
| groupCode | string | 必须 | 分组编码 |
| parentId | number | 必须 | 父分组ID（0表示根节点） |
| description | string | 否 | 分组描述 |
| sortOrder | number | 必须 | 排序权重 |
| children | object[] | 否 | 子分组列表（树形结构） |

#### 2.6.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "groupName": "默认分组",
      "groupCode": "default",
      "parentId": 0,
      "description": "系统默认设备分组",
      "sortOrder": 0,
      "children": []
    },
    {
      "id": 2,
      "groupName": "生产环境",
      "groupCode": "production",
      "parentId": 0,
      "description": "生产环境设备",
      "sortOrder": 100,
      "children": []
    }
  ]
}
```

---

### 2.7 获取设备统计

#### 2.7.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/statistics` |
| 请求方式 | `GET` |
| 接口描述 | 获取设备概览统计数据 |
| 是否需要认证 | 是 |

#### 2.7.2 请求参数

无

#### 2.7.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| totalCount | number | 必须 | 设备总数 |
| onlineCount | number | 必须 | 在线设备数 |
| offlineCount | number | 必须 | 离线设备数 |
| faultCount | number | 必须 | 故障设备数 |
| maintainCount | number | 必须 | 维护中设备数 |
| onlineRate | number | 必须 | 在线率（百分比） |
| groupStatistics | object[] | 必须 | 分组统计 |
| &nbsp;&nbsp;groupId | number | 必须 | 分组ID |
| &nbsp;&nbsp;groupName | string | 必须 | 分组名称 |
| &nbsp;&nbsp;deviceCount | number | 必须 | 设备数量 |
| &nbsp;&nbsp;onlineCount | number | 必须 | 在线数量 |

#### 2.7.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "totalCount": 100,
    "onlineCount": 85,
    "offlineCount": 10,
    "faultCount": 3,
    "maintainCount": 2,
    "onlineRate": 85.0,
    "groupStatistics": [
      {
        "groupId": 2,
        "groupName": "生产环境",
        "deviceCount": 50,
        "onlineCount": 48
      },
      {
        "groupId": 3,
        "groupName": "测试环境",
        "deviceCount": 30,
        "onlineCount": 25
      }
    ]
  }
}
```

---

## 3. 设备配置接口

### 3.1 获取设备配置

#### 3.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/config` |
| 请求方式 | `GET` |
| 接口描述 | 获取指定设备的所有配置项 |
| 是否需要认证 | 是 |

#### 3.1.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |

#### 3.1.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| configId | number | 必须 | 配置ID |
| configKey | string | 必须 | 配置键 |
| configValue | string | 必须 | 配置值 |
| configType | string | 必须 | 配置类型 |
| description | string | 否 | 配置说明 |
| isSynced | boolean | 必须 | 是否已同步 |
| syncTime | string | 否 | 同步时间 |
| updatedAt | string | 必须 | 更新时间 |

#### 3.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "configId": 1,
      "configKey": "heartbeat_interval",
      "configValue": "60",
      "configType": "number",
      "description": "心跳间隔（秒）",
      "isSynced": true,
      "syncTime": "2025-12-11 10:00:00",
      "updatedAt": "2025-12-11 10:00:00"
    },
    {
      "configId": 2,
      "configKey": "report_interval",
      "configValue": "300",
      "configType": "number",
      "description": "状态上报间隔（秒）",
      "isSynced": false,
      "syncTime": null,
      "updatedAt": "2025-12-11 10:30:00"
    }
  ]
}
```

---

### 3.2 更新设备配置

#### 3.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/config` |
| 请求方式 | `PUT` |
| 接口描述 | 批量更新设备配置项，更新后需要手动同步 |
| 是否需要认证 | 是（需要配置管理权限） |

#### 3.2.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| configs | object[] | 必须 | [...] | 配置项列表 |
| &nbsp;&nbsp;configKey | string | 必须 | heartbeat_interval | 配置键 |
| &nbsp;&nbsp;configValue | string | 必须 | 30 | 配置值 |

#### 3.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| updatedCount | number | 必须 | 更新的配置项数量 |
| needSync | boolean | 必须 | 是否需要同步 |

#### 3.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "配置更新成功",
  "data": {
    "updatedCount": 2,
    "needSync": true
  }
}
```

---

### 3.3 同步配置到设备

#### 3.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/config/sync` |
| 请求方式 | `POST` |
| 接口描述 | 将未同步的配置推送到设备 |
| 是否需要认证 | 是（需要配置管理权限） |

#### 3.3.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |

#### 3.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| syncedCount | number | 必须 | 已同步配置项数量 |
| syncTime | string | 必须 | 同步时间 |
| status | string | 必须 | 同步状态：success/failed |

#### 3.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "配置同步成功",
  "data": {
    "syncedCount": 3,
    "syncTime": "2025-12-11 10:40:00",
    "status": "success"
  }
}
```

---

## 4. 命令控制接口

### 4.1 获取命令列表

#### 4.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/commands` |
| 请求方式 | `GET` |
| 接口描述 | 获取系统支持的所有控制命令 |
| 是否需要认证 | 是 |

#### 4.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| commandType | string | 否 | control | 命令类型筛选 |

#### 4.1.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| commandId | number | 必须 | 命令ID |
| commandCode | string | 必须 | 命令编码 |
| commandName | string | 必须 | 命令名称 |
| commandType | string | 必须 | 命令类型 |
| description | string | 否 | 命令描述 |
| paramSchema | object | 否 | 参数模式（JSON Schema） |
| isActive | boolean | 必须 | 是否启用 |

#### 4.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "commandId": 1,
      "commandCode": "start",
      "commandName": "启动设备",
      "commandType": "control",
      "description": "启动指定设备",
      "paramSchema": null,
      "isActive": true
    },
    {
      "commandId": 2,
      "commandCode": "restart",
      "commandName": "重启设备",
      "commandType": "control",
      "description": "重启指定设备",
      "paramSchema": {
        "type": "object",
        "properties": {
          "delay": {
            "type": "number",
            "description": "延迟时间（秒）"
          }
        }
      },
      "isActive": true
    }
  ]
}
```

---

### 4.2 发送控制命令

#### 4.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/commands` |
| 请求方式 | `POST` |
| 接口描述 | 管理端创建命令记录；服务器将通过 WebSocket 向目标设备推送命令（HTTP 不直接传输命令给设备）。 |
| 是否需要认证 | 是（需要设备控制权限） |

#### 4.2.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| commandCode | string | 必须 | restart | 命令编码 |
| commandParams | object | 否 | {"delay": 10} | 命令参数 |

#### 4.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| commandLogId | number | 必须 | 命令执行记录ID |
| deviceId | number | 必须 | 设备ID |
| deviceName | string | 必须 | 设备名称 |
| commandCode | string | 必须 | 命令编码 |
| status | string | 必须 | 执行状态 |
| executeTime | string | 必须 | 执行时间 |

#### 4.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "命令已发送",
  "data": {
    "commandLogId": 1001,
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "commandCode": "restart",
    "status": "sending",
    "executeTime": "2025-12-11 10:45:00"
  }
}
```

---

### 4.3 查询命令执行状态

#### 4.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/commands/logs/{id}` |
| 请求方式 | `GET` |
| 接口描述 | 查询指定命令的执行结果 |
| 是否需要认证 | 是 |

#### 4.3.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 命令日志ID |

#### 4.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| commandLogId | number | 必须 | 命令日志ID |
| deviceId | number | 必须 | 设备ID |
| deviceName | string | 必须 | 设备名称 |
| commandCode | string | 必须 | 命令编码 |
| commandName | string | 必须 | 命令名称 |
| commandParams | object | 否 | 命令参数 |
| executeUser | string | 否 | 执行用户 |
| executeTime | string | 必须 | 执行时间 |
| status | string | 必须 | 执行状态 |
| responseData | object | 否 | 响应数据 |
| errorMessage | string | 否 | 错误信息 |
| responseTime | string | 否 | 响应时间 |
| duration | number | 否 | 执行耗时（毫秒） |

#### 4.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "commandLogId": 1001,
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "commandCode": "restart",
    "commandName": "重启设备",
    "commandParams": {
      "delay": 10
    },
    "executeUser": "admin",
    "executeTime": "2025-12-11 10:45:00",
    "status": "success",
    "responseData": {
      "message": "设备已成功重启"
    },
    "errorMessage": null,
    "responseTime": "2025-12-11 10:45:15",
    "duration": 15000
  }
}
```

---

### 4.4 获取命令执行历史

#### 4.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/commands/history` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询指定设备的命令执行历史记录 |
| 是否需要认证 | 是 |

#### 4.4.2 请求参数 (路径参数 & queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 4.4.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 命令执行记录列表 |
| &nbsp;&nbsp;commandLogId | number | 必须 | 命令日志ID |
| &nbsp;&nbsp;deviceId | number | 必须 | 设备ID |
| &nbsp;&nbsp;deviceName | string | 必须 | 设备名称 |
| &nbsp;&nbsp;commandCode | string | 必须 | 命令编码 |
| &nbsp;&nbsp;commandName | string | 必须 | 命令名称 |
| &nbsp;&nbsp;commandParams | object | 否 | 命令参数 |
| &nbsp;&nbsp;executeUser | string | 否 | 执行用户 |
| &nbsp;&nbsp;executeTime | string | 必须 | 执行时间 |
| &nbsp;&nbsp;status | string | 必须 | 执行状态：pending/sending/success/failed/timeout |
| &nbsp;&nbsp;responseTime | string | 否 | 响应时间 |
| &nbsp;&nbsp;duration | number | 否 | 执行耗时（毫秒） |

#### 4.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 50,
    "rows": [
      {
        "commandLogId": 1001,
        "deviceId": 1,
        "deviceName": "生产服务器01",
        "commandCode": "restart",
        "commandName": "重启设备",
        "commandParams": {
          "delay": 10
        },
        "executeUser": "admin",
        "executeTime": "2025-12-11 10:45:00",
        "status": "success",
        "responseTime": "2025-12-11 10:45:15",
        "duration": 15000
      },
      {
        "commandLogId": 1002,
        "deviceId": 1,
        "deviceName": "生产服务器01",
        "commandCode": "start",
        "commandName": "启动设备",
        "commandParams": null,
        "executeUser": "admin",
        "executeTime": "2025-12-11 09:30:00",
        "status": "success",
        "responseTime": "2025-12-11 09:30:05",
        "duration": 5000
      }
    ]
  }
}
```

---

## 5. 状态监控接口

### 5.1 获取设备实时状态

#### 5.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/status` |
| 请求方式 | `GET` |
| 接口描述 | 获取设备当前实时状态信息 |
| 是否需要认证 | 是 |

#### 5.1.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 设备ID |

#### 5.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| deviceId | number | 必须 | 设备ID |
| deviceName | string | 必须 | 设备名称 |
| onlineStatus | number | 必须 | 在线状态 |
| doorStatus | string | 否 | 门状态：open/closed |
| doorControllerStatus | string | 否 | 门禁控制器状态：normal/fault/... |
| customData | object | 否 | 自定义数据（门禁相关扩展） |
| reportTime | string | 必须 | 上报时间 |

#### 5.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "onlineStatus": 1,
    "doorStatus": "closed",
    "doorControllerStatus": "normal",
    "customData": {
      "lastOpenEventId": 12345
    },
    "reportTime": "2025-12-11 10:50:00"
  }
}
```

---

### 5.2 获取设备状态历史

#### 5.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/status/history` |
| 请求方式 | `GET` |
| 接口描述 | 获取设备历史状态数据，用于趋势分析和图表展示 |
| 是否需要认证 | 是 |

#### 5.2.2 请求参数 (路径参数 & queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| startTime | string | 必须 | 2025-12-11 00:00:00 | 开始时间 |
| endTime | string | 必须 | 2025-12-11 23:59:59 | 结束时间 |
| statusType | string | 否 | cpu | 状态类型筛选 |
| interval | string | 否 | 5m | 采样间隔：1m/5m/10m/30m/1h |

#### 5.2.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| reportTime | string | 必须 | 上报时间 |
| doorStatus | string | 否 | 门状态：open/closed |
| doorControllerStatus | number | 否 | 门禁控制器状态（normal/fault/...） |

#### 5.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "reportTime": "2025-12-11 10:00:00",
      "cpuUsage": 35.2,
      "memoryUsage": 65.8,
      "diskUsage": 52.0,
      "temperature": 40.5,
      "networkIn": 950000,
      "networkOut": 1850000
    },
    {
      "reportTime": "2025-12-11 10:05:00",
      "cpuUsage": 42.8,
      "memoryUsage": 67.2,
      "diskUsage": 52.1,
      "temperature": 41.2,
      "networkIn": 1020000,
      "networkOut": 1950000
    }
  ]
}
---
```

---

### 5.2.5 批量获取设备状态历史（按时间范围，支持多设备筛选）

#### 5.2.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/status/history` |
| 请求方式 | `GET` |
| 接口描述 | 按时间范围批量查询设备的历史状态数据，支持按设备列表、设备编码、分组或状态类型筛选，用于跨设备趋势分析和聚合展示 |
| 是否需要认证 | 是 |

#### 5.2.5.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| startTime | string | 必须 | 2025-12-11 00:00:00 | 开始时间（格式：yyyy-MM-dd HH:mm:ss） |
| endTime | string | 必须 | 2025-12-11 23:59:59 | 结束时间（格式：yyyy-MM-dd HH:mm:ss） |
| deviceIds | number[] | 否 | [1,2,3] | 设备ID列表（优先于 deviceCode） |
| deviceCode | string | 否 | DEV-001 | 单一设备编码（与 deviceIds 二选一） |
| groupId | number | 否 | 2 | 设备分组ID（筛选该分组下所有设备） |
| statusType | string | 否 | access | 状态类型筛选（如 cpu / access / system 等） |
| interval | string | 否 | 5m | 采样间隔：1m/5m/10m/30m/1h（用于下采样/聚合场景） |
| page | number | 否 | 1 | 分页页码，从1开始，默认1 |
| pageSize | number | 否 | 50 | 每页记录数，默认50，最大1000 |
| sort | string | 否 | reportTime_desc | 排序：reportTime_desc / reportTime_asc |

> 说明：接口强制要求 `startTime` 和 `endTime`，用于限定时间窗口；其他筛选参数可组合使用。若既未传 `deviceIds` 也未传 `deviceCode` 与 `groupId`，则返回所有设备在指定时间范围内的历史（按分页）。

#### 5.2.5.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数（分页场景） |
| rows | object[] | 必须 | 状态记录列表 |
| &nbsp;&nbsp;deviceId | number | 必须 | 设备ID |
| &nbsp;&nbsp;deviceCode | string | 必须 | 设备编码 |
| &nbsp;&nbsp;deviceName | string | 否 | 设备名称 |
| &nbsp;&nbsp;reportTime | string | 必须 | 上报时间 |
| &nbsp;&nbsp;statusType | string | 必须 | 状态类型 |
| &nbsp;&nbsp;doorStatus | string | 否 | 门状态（门禁场景）：open/closed |
| &nbsp;&nbsp;doorControllerStatus | string | 否 | 门禁控制器状态：normal/fault/... |
| &nbsp;&nbsp;customData | object | 否 | 自定义字段，源自 status_value（JSON） |

#### 5.2.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 2,
    "rows": [
      {
        "deviceId": 1,
        "deviceCode": "DEV-001",
        "deviceName": "生产服务器01",
        "reportTime": "2025-12-11 10:00:00",
        "statusType": "access",
        "doorStatus": "closed",
        "doorControllerStatus": "normal",
        "customData": {
          "cpuUsage": 35.2,
          "memoryUsage": 65.8
        }
      },
      {
        "deviceId": 2,
        "deviceCode": "DEV-002",
        "deviceName": "测试服务器01",
        "reportTime": "2025-12-11 10:00:00",
        "statusType": "system",
        "doorStatus": null,
        "doorControllerStatus": null,
        "customData": {
          "cpuUsage": 42.8,
          "memoryUsage": 67.2
        }
      }
    ]
  }
}
```

#### 5.2.5.5 实现说明（与数据库映射）

- 建议在后端使用表 `device_status_history`（字段：device_id, status_type, status_value, report_time, created_at）按时间范围组合设备过滤查询，并支持按 `interval` 做下采样或聚合（可使用 GROUP BY 时间槽或在应用层做聚合）。
- 当需要返回大量数据时，建议开启分页（`page` / `pageSize`）或使用流式导出接口。

---

### 5.3 获取设备心跳记录

#### 5.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/devices/{id}/heartbeat` |
| 请求方式 | `GET` |
| 接口描述 | 获取指定设备的心跳历史记录，用于分析设备在线状态 |
| 是否需要认证 | 是 |

#### 5.3.2 请求参数 (路径参数 & queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：设备ID |
| startTime | string | 否 | 2025-12-11 00:00:00 | 开始时间（可选，默认最近24小时） |
| endTime | string | 否 | 2025-12-11 23:59:59 | 结束时间（可选，默认当前时间） |
| limit | number | 否 | 100 | 返回记录数限制（可选，默认100，最大1000） |

#### 5.3.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 心跳记录ID |
| deviceId | number | 必须 | 设备ID |
| heartbeatTime | string | 必须 | 心跳时间 |
| ipAddress | string | 否 | 上报IP地址 |
| responseTime | number | 否 | 响应时间（毫秒） |
| extraData | object | 否 | 额外数据（JSON） |
| createdAt | string | 必须 | 创建时间 |

#### 5.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "id": 10001,
      "deviceId": 1,
      "heartbeatTime": "2025-12-11 10:30:00",
      "ipAddress": "192.168.1.100",
      "responseTime": 12,
      "extraData": {
        "version": "1.0.0",
        "uptime": 259200
      },
      "createdAt": "2025-12-11 10:30:00"
    },
    {
      "id": 10002,
      "deviceId": 1,
      "heartbeatTime": "2025-12-11 10:29:30",
      "ipAddress": "192.168.1.100",
      "responseTime": 15,
      "extraData": {
        "version": "1.0.0",
        "uptime": 259170
      },
      "createdAt": "2025-12-11 10:29:30"
    },
    {
      "id": 10003,
      "deviceId": 1,
      "heartbeatTime": "2025-12-11 10:29:00",
      "ipAddress": "192.168.1.100",
      "responseTime": 10,
      "extraData": {
        "version": "1.0.0",
        "uptime": 259140
      },
      "createdAt": "2025-12-11 10:29:00"
    }
  ]
}
```

---

## 6. 告警管理接口

### 6.1 获取告警列表

#### 6.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询告警记录，支持多条件筛选 |
| 是否需要认证 | 是 |

#### 6.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceId | number | 否 | 1 | 设备ID筛选 |
| alertLevel | string | 否 | error | 告警级别：info/warning/error/critical |
| status | string | 否 | pending | 状态：pending/confirmed/resolved/ignored |
| startTime | string | 否 | 2025-12-11 00:00:00 | 开始时间 |
| endTime | string | 否 | 2025-12-11 23:59:59 | 结束时间 |
| page | number | 是 | 1 | 页码 |
| pageSize | number | 是 | 10 | 每页记录数 |

#### 6.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 告警列表 |
| &nbsp;&nbsp;alertId | number | 必须 | 告警ID |
| &nbsp;&nbsp;alertNo | string | 必须 | 告警编号 |
| &nbsp;&nbsp;deviceId | number | 必须 | 设备ID |
| &nbsp;&nbsp;deviceName | string | 必须 | 设备名称 |
| &nbsp;&nbsp;alertLevel | string | 必须 | 告警级别 |
| &nbsp;&nbsp;alertType | string | 必须 | 告警类型 |
| &nbsp;&nbsp;alertMessage | string | 必须 | 告警消息 |
| &nbsp;&nbsp;status | string | 必须 | 处理状态 |
| &nbsp;&nbsp;alertTime | string | 必须 | 告警时间 |
| &nbsp;&nbsp;confirmedUser | string | 否 | 确认用户 |
| &nbsp;&nbsp;confirmedTime | string | 否 | 确认时间 |

#### 6.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 15,
    "rows": [
      {
        "alertId": 1,
        "alertNo": "ALT-20251211-001",
        "deviceId": 1,
        "deviceName": "生产服务器01",
        "alertLevel": "warning",
        "alertType": "door_not_closed_timeout",
        "alertMessage": "设备 生产服务器01 门未关闭超过30秒",
        "status": "pending",
        "alertTime": "2025-12-11 10:30:00",
        "confirmedUser": null,
        "confirmedTime": null
      },
      {
        "alertId": 2,
        "alertNo": "ALT-20251211-002",
        "deviceId": 2,
        "deviceName": "测试服务器01",
        "alertLevel": "error",
        "alertType": "device_offline",
        "alertMessage": "设备 测试服务器01 已离线超过5分钟",
        "status": "confirmed",
        "alertTime": "2025-12-11 09:20:00",
        "confirmedUser": "admin",
        "confirmedTime": "2025-12-11 09:25:00"
      }
    ]
  }
}
```

---

### 6.2 获取告警详情

#### 6.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts/{id}` |
| 请求方式 | `GET` |
| 接口描述 | 获取单条告警的详细信息 |
| 是否需要认证 | 是 |

#### 6.2.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 告警ID |

#### 6.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| alertId | number | 必须 | 告警ID |
| alertNo | string | 必须 | 告警编号 |
| ruleId | number | 否 | 规则ID |
| deviceId | number | 必须 | 设备ID |
| deviceName | string | 必须 | 设备名称 |
| alertLevel | string | 必须 | 告警级别 |
| alertType | string | 必须 | 告警类型 |
| alertMessage | string | 必须 | 告警消息 |
| alertData | object | 否 | 告警数据（JSON） |
| status | string | 必须 | 处理状态 |
| alertTime | string | 必须 | 告警时间 |
| confirmedUserId | number | 否 | 确认用户ID |
| confirmedUser | string | 否 | 确认用户名 |
| confirmedTime | string | 否 | 确认时间 |
| resolvedUserId | number | 否 | 解决用户ID |
| resolvedUser | string | 否 | 解决用户名 |
| resolvedTime | string | 否 | 解决时间 |
| resolveRemark | string | 否 | 处理备注 |
| createdAt | string | 必须 | 创建时间 |
| updatedAt | string | 必须 | 更新时间 |

#### 6.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "alertId": 1,
    "alertNo": "ALT-20251211-001",
    "ruleId": 2,
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "alertLevel": "warning",
    "alertType": "door_not_closed_timeout",
    "alertMessage": "设备 生产服务器01 门未关闭超过30秒",
    "alertData": {
      "doorStatus": "open",
      "thresholdSeconds": 30
    },
    "status": "pending",
    "alertTime": "2025-12-11 10:30:00",
    "confirmedUserId": null,
    "confirmedUser": null,
    "confirmedTime": null,
    "resolvedUserId": null,
    "resolvedUser": null,
    "resolvedTime": null,
    "resolveRemark": null,
    "createdAt": "2025-12-11 10:30:00",
    "updatedAt": "2025-12-11 10:30:00"
  }
}
```

---

### 6.3 确认告警

#### 6.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts/{id}/confirm` |
| 请求方式 | `PUT` |
| 接口描述 | 确认告警，标记为已确认状态 |
| 是否需要认证 | 是（需要告警处理权限） |

#### 6.3.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 路径参数：告警ID |

#### 6.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| alertId | number | 必须 | 告警ID |
| status | string | 必须 | 更新后的状态 |
| confirmedUser | string | 必须 | 确认用户 |
| confirmedTime | string | 必须 | 确认时间 |

#### 6.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "告警已确认",
  "data": {
    "alertId": 1,
    "status": "confirmed",
    "confirmedUser": "admin",
    "confirmedTime": "2025-12-11 10:35:00"
  }
}
```

---

### 6.4 解决告警

#### 6.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts/{id}/resolve` |
| 请求方式 | `PUT` |
| 接口描述 | 标记告警为已解决 |
| 是否需要认证 | 是（需要告警处理权限） |

#### 6.4.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：告警ID |
| resolveRemark | string | 否 | 已重启服务恢复正常 | 处理备注 |

#### 6.4.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| alertId | number | 必须 | 告警ID |
| status | string | 必须 | 更新后的状态 |
| resolvedUser | string | 必须 | 解决用户 |
| resolvedTime | string | 必须 | 解决时间 |

#### 6.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "告警已解决",
  "data": {
    "alertId": 1,
    "status": "resolved",
    "resolvedUser": "admin",
    "resolvedTime": "2025-12-11 11:00:00"
  }
}
```

---

### 6.5 忽略告警

#### 6.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts/{id}/ignore` |
| 请求方式 | `PUT` |
| 接口描述 | 忽略告警，标记为已忽略状态 |
| 是否需要认证 | 是（需要告警处理权限） |

#### 6.5.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 路径参数：告警ID |

#### 6.5.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| alertId | number | 必须 | 告警ID |
| status | string | 必须 | 更新后的状态（ignored） |

#### 6.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "告警已忽略",
  "data": {
    "alertId": 1,
    "status": "ignored"
  }
}
```

---

### 6.6 获取告警统计

#### 6.6.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/alerts/statistics` |
| 请求方式 | `GET` |
| 接口描述 | 获取告警统计数据 |
| 是否需要认证 | 是 |

#### 6.6.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| timeRange | string | 否 | today | 时间范围：today/week/month |

#### 6.6.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| totalCount | number | 必须 | 总告警数 |
| pendingCount | number | 必须 | 待处理数 |
| confirmedCount | number | 必须 | 已确认数 |
| resolvedCount | number | 必须 | 已解决数 |
| criticalCount | number | 必须 | 严重告警数 |
| errorCount | number | 必须 | 错误告警数 |
| warningCount | number | 必须 | 警告告警数 |
| levelDistribution | object[] | 必须 | 级别分布 |
| typeDistribution | object[] | 必须 | 类型分布 |

#### 6.6.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "totalCount": 156,
    "pendingCount": 25,
    "confirmedCount": 15,
    "resolvedCount": 110,
    "criticalCount": 5,
    "errorCount": 20,
    "warningCount": 131,
    "levelDistribution": [
      {"level": "critical", "count": 5},
      {"level": "error", "count": 20},
      {"level": "warning", "count": 131}
    ],
    "typeDistribution": [
      {"type": "device_offline", "count": 25},
      {"type": "cpu_high", "count": 50},
      {"type": "memory_high", "count": 45},
      {"type": "disk_high", "count": 36}
    ]
  }
}
```

---

## 7. 报表管理接口

### 7.1 获取报表配置列表

#### 7.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/reports/configs` |
| 请求方式 | `GET` |
| 接口描述 | 获取系统配置的报表模板列表 |
| 是否需要认证 | 是 |

#### 7.1.2 请求参数

无

#### 7.1.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 报表配置ID |
| reportName | string | 必须 | 报表名称 |
| reportCode | string | 必须 | 报表编码 |
| reportType | string | 必须 | 报表类型：device/status/alert/command |
| description | string | 否 | 报表描述 |
| isActive | boolean | 必须 | 是否启用 |

#### 7.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "reportName": "设备状态报表",
      "reportCode": "device_status_report",
      "reportType": "status",
      "description": "设备状态监控报表",
      "isActive": true
    },
    {
      "id": 2,
      "reportName": "告警统计报表",
      "reportCode": "alert_statistics_report",
      "reportType": "alert",
      "description": "告警统计分析报表",
      "isActive": true
    }
  ]
}
```

---

### 7.2 生成报表

#### 7.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/reports/generate` |
| 请求方式 | `POST` |
| 接口描述 | 创建报表生成任务，支持Excel和PDF格式 |
| 是否需要认证 | 是（需要报表导出权限） |

#### 7.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| reportCode | string | 必须 | device_status_report | 报表编码 |
| fileFormat | string | 必须 | excel | 文件格式：excel/pdf |
| params | object | 否 | {...} | 报表参数 |
| &nbsp;&nbsp;startTime | string | 否 | 2025-12-01 | 开始时间 |
| &nbsp;&nbsp;endTime | string | 否 | 2025-12-11 | 结束时间 |
| &nbsp;&nbsp;deviceIds | number[] | 否 | [1, 2, 3] | 设备ID列表 |

#### 7.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| reportLogId | number | 必须 | 报表生成记录ID |
| reportName | string | 必须 | 报表名称 |
| status | string | 必须 | 生成状态 |
| generateTime | string | 必须 | 生成时间 |

#### 7.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "报表生成任务已创建",
  "data": {
    "reportLogId": 101,
    "reportName": "设备状态报表",
    "status": "generating",
    "generateTime": "2025-12-11 11:00:00"
  }
}
```

---

### 7.3 获取报表生成记录

#### 7.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/reports/logs` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询报表生成历史记录 |
| 是否需要认证 | 是 |

#### 7.3.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| reportCode | string | 否 | device_status_report | 报表编码筛选 |
| status | string | 否 | success | 生成状态：generating/success/failed |
| startTime | string | 否 | 2025-12-01 | 开始时间 |
| endTime | string | 否 | 2025-12-11 | 结束时间 |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 7.3.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 报表生成记录列表 |
| &nbsp;&nbsp;id | number | 必须 | 记录ID |
| &nbsp;&nbsp;reportName | string | 必须 | 报表名称 |
| &nbsp;&nbsp;reportCode | string | 必须 | 报表编码 |
| &nbsp;&nbsp;fileFormat | string | 必须 | 文件格式：excel/pdf |
| &nbsp;&nbsp;fileSize | number | 否 | 文件大小（字节） |
| &nbsp;&nbsp;status | string | 必须 | 生成状态 |
| &nbsp;&nbsp;generateTime | string | 必须 | 生成时间 |
| &nbsp;&nbsp;completeTime | string | 否 | 完成时间 |
| &nbsp;&nbsp;errorMessage | string | 否 | 错误信息 |

#### 7.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 25,
    "rows": [
      {
        "id": 101,
        "reportName": "设备状态报表",
        "reportCode": "device_status_report",
        "fileFormat": "excel",
        "fileSize": 256000,
        "status": "success",
        "generateTime": "2025-12-11 11:00:00",
        "completeTime": "2025-12-11 11:00:15",
        "errorMessage": null
      }
    ]
  }
}
```

---

### 7.4 下载报表

#### 7.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/reports/download/{id}` |
| 请求方式 | `GET` |
| 接口描述 | 下载已生成的报表文件 |
| 是否需要认证 | 是 |

#### 7.4.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 报表生成记录ID |

#### 7.4.3 响应

直接返回文件流，设置Content-Disposition响应头

---

## 8. 操作日志接口

### 8.1 获取操作日志

#### 8.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/logs/operations` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询系统操作日志 |
| 是否需要认证 | 是（需要日志查看权限） |

#### 8.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| userId | number | 否 | 1 | 用户ID筛选 |
| operationType | string | 否 | create | 操作类型筛选 |
| operationModule | string | 否 | device | 操作模块筛选 |
| startTime | string | 否 | 2025-12-01 00:00:00 | 开始时间 |
| endTime | string | 否 | 2025-12-11 23:59:59 | 结束时间 |
| status | number | 否 | 1 | 状态筛选：0-失败 1-成功 |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 8.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 操作日志列表 |
| &nbsp;&nbsp;id | number | 必须 | 日志ID |
| &nbsp;&nbsp;userId | number | 否 | 操作用户ID |
| &nbsp;&nbsp;username | string | 否 | 操作用户名 |
| &nbsp;&nbsp;operationType | string | 必须 | 操作类型 |
| &nbsp;&nbsp;operationModule | string | 必须 | 操作模块 |
| &nbsp;&nbsp;operationDesc | string | 否 | 操作描述 |
| &nbsp;&nbsp;requestMethod | string | 否 | 请求方法 |
| &nbsp;&nbsp;requestUrl | string | 否 | 请求URL |
| &nbsp;&nbsp;ipAddress | string | 否 | IP地址 |
| &nbsp;&nbsp;status | number | 必须 | 状态：0-失败 1-成功 |
| &nbsp;&nbsp;errorMessage | string | 否 | 错误信息 |
| &nbsp;&nbsp;executeTime | number | 否 | 执行耗时（毫秒） |
| &nbsp;&nbsp;createdAt | string | 必须 | 创建时间 |

#### 8.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 150,
    "rows": [
      {
        "id": 1,
        "userId": 1,
        "username": "admin",
        "operationType": "create",
        "operationModule": "device",
        "operationDesc": "添加设备",
        "requestMethod": "POST",
        "requestUrl": "/api/devices",
        "ipAddress": "192.168.1.100",
        "status": 1,
        "errorMessage": null,
        "executeTime": 45,
        "createdAt": "2025-12-11 10:35:00"
      }
    ]
  }
}
```

---

## 9. 管理端-用户管理接口

### 9.1 获取用户列表

#### 9.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/users` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询系统用户列表 |
| 是否需要认证 | 是（需要管理员权限） |

#### 9.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 9.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 用户列表 |
| &nbsp;&nbsp;id | number | 必须 | 用户ID |
| &nbsp;&nbsp;username | string | 必须 | 用户名 |
| &nbsp;&nbsp;realName | string | 否 | 真实姓名 |
| &nbsp;&nbsp;email | string | 否 | 邮箱 |
| &nbsp;&nbsp;phone | string | 否 | 手机号 |
| &nbsp;&nbsp;status | number | 必须 | 状态：0-禁用 1-正常 |
| &nbsp;&nbsp;isAdmin | number | 必须 | 是否管理员：0-否 1-是 |
| &nbsp;&nbsp;lastLoginTime | string | 否 | 最后登录时间 |
| &nbsp;&nbsp;createdAt | string | 必须 | 创建时间 |

#### 9.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 25,
    "rows": [
      {
        "id": 1,
        "username": "admin",
        "realName": "系统管理员",
        "email": "admin@example.com",
        "phone": "13800138000",
        "status": 1,
        "isAdmin": 1,
        "lastLoginTime": "2025-12-11 10:00:00",
        "createdAt": "2025-01-01 00:00:00"
      }
    ]
  }
}
```

---

### 9.2 创建用户

#### 9.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/users` |
| 请求方式 | `POST` |
| 接口描述 | 创建新用户 |
| 是否需要认证 | 是（需要管理员权限） |

#### 9.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| username | string | 必须 | testuser | 用户名（唯一） |
| password | string | 必须 | 123456 | 密码 |
| realName | string | 否 | 测试用户 | 真实姓名 |
| email | string | 否 | test@example.com | 邮箱 |
| phone | string | 否 | 13800138000 | 手机号 |
| avatarUrl | string | 否 | https://... | 头像URL |
| status | boolean | 否 | true | 状态：true-启用 false-禁用 |
| isAdmin | boolean | 否 | false | 是否管理员 |

#### 9.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 新创建的用户ID |
| username | string | 必须 | 用户名 |
| createdAt | string | 必须 | 创建时间 |

#### 9.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "创建成功",
  "data": {
    "id": 26,
    "username": "testuser",
    "createdAt": "2025-12-11 10:35:00"
  }
}
```

---

### 9.3 更新用户

#### 9.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/users/{id}` |
| 请求方式 | `PUT` |
| 接口描述 | 更新用户信息 |
| 是否需要认证 | 是（需要管理员权限） |

#### 9.3.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：用户ID |
| realName | string | 否 | 测试用户 | 真实姓名 |
| email | string | 否 | test@example.com | 邮箱 |
| phone | string | 否 | 13800138000 | 手机号 |
| avatarUrl | string | 否 | https://... | 头像URL |
| status | boolean | 否 | true | 状态 |
| isAdmin | boolean | 否 | false | 是否管理员 |

#### 9.3.3 响应数据字段 (data: null)

无

#### 9.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "更新成功",
  "data": null
}
```

---

### 9.4 删除用户

#### 9.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/users/{id}` |
| 请求方式 | `DELETE` |
| 接口描述 | 删除指定用户 |
| 是否需要认证 | 是（需要管理员权限） |

#### 9.4.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 用户ID |

#### 9.4.3 响应数据字段 (data: null)

无

#### 9.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "删除成功",
  "data": null
}
```

---

### 9.5 重置密码

#### 9.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/users/{id}/reset-password` |
| 请求方式 | `PUT` |
| 接口描述 | 重置指定用户的密码 |
| 是否需要认证 | 是（需要管理员权限） |

#### 9.5.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：用户ID |
| password | string | 必须 | 123456 | 新密码 |

#### 9.5.3 响应数据字段 (data: null)

无

#### 9.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "重置成功",
  "data": null
}
```

---

## 10. 管理端-角色权限接口

### 10.1 获取角色列表

#### 10.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/roles` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询系统角色列表 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 10.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 角色列表 |
| &nbsp;&nbsp;id | number | 必须 | 角色ID |
| &nbsp;&nbsp;roleCode | string | 必须 | 角色编码 |
| &nbsp;&nbsp;roleName | string | 必须 | 角色名称 |
| &nbsp;&nbsp;description | string | 否 | 角色描述 |
| &nbsp;&nbsp;status | number | 必须 | 状态：0-禁用 1-正常 |
| &nbsp;&nbsp;createdAt | string | 必须 | 创建时间 |

#### 10.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 5,
    "rows": [
      {
        "id": 1,
        "roleCode": "admin",
        "roleName": "系统管理员",
        "description": "拥有系统所有权限",
        "status": 1,
        "createdAt": "2025-01-01 00:00:00"
      }
    ]
  }
}
```

---

### 10.2 创建角色

#### 10.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/roles` |
| 请求方式 | `POST` |
| 接口描述 | 创建新角色 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| roleCode | string | 必须 | monitor | 角色编码（唯一） |
| roleName | string | 必须 | 监控人员 | 角色名称 |
| description | string | 否 | 可查看监控数据 | 角色描述 |
| status | number | 否 | 1 | 状态：0-禁用 1-正常 |

#### 10.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 新创建的角色ID |
| roleCode | string | 必须 | 角色编码 |
| roleName | string | 必须 | 角色名称 |
| createdAt | string | 必须 | 创建时间 |

#### 10.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "创建成功",
  "data": {
    "id": 6,
    "roleCode": "monitor",
    "roleName": "监控人员",
    "createdAt": "2025-12-11 10:35:00"
  }
}
```

---

### 10.3 更新角色

#### 10.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/roles/{id}` |
| 请求方式 | `PUT` |
| 接口描述 | 更新角色信息 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.3.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：角色ID |
| roleName | string | 否 | 监控人员 | 角色名称 |
| description | string | 否 | 可查看监控数据 | 角色描述 |
| status | number | 否 | 1 | 状态 |

#### 10.3.3 响应数据字段 (data: null)

无

#### 10.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "更新成功",
  "data": null
}
```

---

### 10.4 删除角色

#### 10.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/roles/{id}` |
| 请求方式 | `DELETE` |
| 接口描述 | 删除指定角色 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.4.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 角色ID |

#### 10.4.3 响应数据字段 (data: null)

无

#### 10.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "删除成功",
  "data": null
}
```

---

### 10.5 分配权限

#### 10.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/roles/{id}/permissions` |
| 请求方式 | `PUT` |
| 接口描述 | 为角色分配权限 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.5.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：角色ID |
| permissionIds | number[] | 必须 | [1, 2, 3] | 权限ID列表 |

#### 10.5.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| roleId | number | 必须 | 角色ID |
| assignedCount | number | 必须 | 已分配权限数量 |

#### 10.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "权限分配成功",
  "data": {
    "roleId": 1,
    "assignedCount": 3
  }
}
```

---

### 10.6 获取权限列表

#### 10.6.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/permissions` |
| 请求方式 | `GET` |
| 接口描述 | 获取权限树形结构 |
| 是否需要认证 | 是（需要管理员权限） |

#### 10.6.2 请求参数

无

#### 10.6.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 权限ID |
| permissionCode | string | 必须 | 权限编码 |
| permissionName | string | 必须 | 权限名称 |
| resourceType | string | 必须 | 资源类型：menu/button/api |
| parentId | number | 必须 | 父权限ID（0表示根节点） |
| resourcePath | string | 否 | 资源路径 |
| description | string | 否 | 描述 |
| sortOrder | number | 必须 | 排序权重 |
| children | object[] | 否 | 子权限列表（树形结构） |

#### 10.6.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "id": 1,
      "permissionCode": "system",
      "permissionName": "系统管理",
      "resourceType": "menu",
      "parentId": 0,
      "resourcePath": "/system",
      "description": null,
      "sortOrder": 0,
      "children": [
        {
          "id": 2,
          "permissionCode": "system:user",
          "permissionName": "用户管理",
          "resourceType": "menu",
          "parentId": 1,
          "resourcePath": "/system/user",
          "sortOrder": 0,
          "children": []
        }
      ]
    }
  ]
}
```

---

## 11. 管理端-告警规则接口

### 11.1 获取告警规则

#### 11.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/alert-rules` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询告警规则列表 |
| 是否需要认证 | 是（需要管理员权限） |

#### 11.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| ruleType | string | 否 | threshold | 规则类型筛选 |
| isActive | boolean | 否 | true | 是否启用筛选 |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 11.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 告警规则列表 |
| &nbsp;&nbsp;id | number | 必须 | 规则ID |
| &nbsp;&nbsp;ruleName | string | 必须 | 规则名称 |
| &nbsp;&nbsp;ruleCode | string | 必须 | 规则编码 |
| &nbsp;&nbsp;ruleType | string | 必须 | 规则类型 |
| &nbsp;&nbsp;alertLevel | string | 必须 | 告警级别 |
| &nbsp;&nbsp;isActive | boolean | 必须 | 是否启用 |
| &nbsp;&nbsp;createdAt | string | 必须 | 创建时间 |

#### 11.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 10,
    "rows": [
      {
        "id": 1,
        "ruleName": "设备离线告警",
        "ruleCode": "device_offline",
        "ruleType": "offline",
        "alertLevel": "error",
        "isActive": true,
        "createdAt": "2025-01-01 00:00:00"
      }
    ]
  }
}
```

---

### 11.2 创建告警规则

#### 11.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/alert-rules` |
| 请求方式 | `POST` |
| 接口描述 | 创建新的告警规则 |
| 是否需要认证 | 是（需要管理员权限） |

#### 11.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| ruleName | string | 必须 | CPU使用率告警 | 规则名称 |
| ruleCode | string | 必须 | cpu_high | 规则编码（唯一） |
| ruleType | string | 必须 | threshold | 规则类型：offline/threshold/abnormal |
| deviceGroupId | number | 否 | 2 | 应用设备分组ID（为空表示全局） |
| conditionExpr | string | 必须 | cpu_usage > 90 | 条件表达式 |
| alertLevel | string | 必须 | warning | 告警级别：info/warning/error/critical |
| alertMessage | string | 否 | CPU使用率超过90% | 告警消息模板 |
| isActive | boolean | 否 | true | 是否启用 |

#### 11.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 新创建的规则ID |
| ruleCode | string | 必须 | 规则编码 |
| ruleName | string | 必须 | 规则名称 |
| createdAt | string | 必须 | 创建时间 |

#### 11.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "创建成功",
  "data": {
    "id": 11,
    "ruleCode": "cpu_high",
    "ruleName": "CPU使用率告警",
    "createdAt": "2025-12-11 10:35:00"
  }
}
```

---

### 11.3 更新告警规则

#### 11.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/alert-rules/{id}` |
| 请求方式 | `PUT` |
| 接口描述 | 更新告警规则 |
| 是否需要认证 | 是（需要管理员权限） |

#### 11.3.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：规则ID |
| ruleName | string | 否 | CPU使用率告警 | 规则名称 |
| conditionExpr | string | 否 | cpu_usage > 85 | 条件表达式 |
| alertLevel | string | 否 | warning | 告警级别 |
| alertMessage | string | 否 | CPU使用率超过85% | 告警消息模板 |
| isActive | boolean | 否 | true | 是否启用 |

#### 11.3.3 响应数据字段 (data: null)

无

#### 11.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "更新成功",
  "data": null
}
```

---

### 11.4 删除告警规则

#### 11.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/alert-rules/{id}` |
| 请求方式 | `DELETE` |
| 接口描述 | 删除指定告警规则 |
| 是否需要认证 | 是（需要管理员权限） |

#### 11.4.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 规则ID |

#### 11.4.3 响应数据字段 (data: null)

无

#### 11.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "删除成功",
  "data": null
}
```

---

## 12. 管理端-报表配置接口

### 12.1 获取报表配置

#### 12.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/report-configs` |
| 请求方式 | `GET` |
| 接口描述 | 分页查询报表配置列表 |
| 是否需要认证 | 是（需要管理员权限） |

#### 12.1.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| reportType | string | 否 | device | 报表类型筛选 |
| isActive | boolean | 否 | true | 是否启用筛选 |
| page | number | 是 | 1 | 页码，从1开始 |
| pageSize | number | 是 | 10 | 每页记录数，最大100 |

#### 12.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| total | number | 必须 | 总记录数 |
| rows | object[] | 必须 | 报表配置列表 |
| &nbsp;&nbsp;id | number | 必须 | 报表ID |
| &nbsp;&nbsp;reportName | string | 必须 | 报表名称 |
| &nbsp;&nbsp;reportCode | string | 必须 | 报表编码 |
| &nbsp;&nbsp;reportType | string | 必须 | 报表类型 |
| &nbsp;&nbsp;description | string | 否 | 报表描述 |
| &nbsp;&nbsp;isActive | boolean | 必须 | 是否启用 |
| &nbsp;&nbsp;createdAt | string | 必须 | 创建时间 |

#### 12.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": {
    "total": 5,
    "rows": [
      {
        "id": 1,
        "reportName": "设备状态报表",
        "reportCode": "device_status_report",
        "reportType": "status",
        "description": "设备状态监控报表",
        "isActive": true,
        "createdAt": "2025-01-01 00:00:00"
      }
    ]
  }
}
```

---

### 12.2 创建报表配置

#### 12.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/report-configs` |
| 请求方式 | `POST` |
| 接口描述 | 创建新的报表配置 |
| 是否需要认证 | 是（需要管理员权限） |

#### 12.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| reportName | string | 必须 | 设备状态报表 | 报表名称 |
| reportCode | string | 必须 | device_status_report | 报表编码（唯一） |
| reportType | string | 必须 | device | 报表类型：device/status/alert/command |
| reportTemplate | string | 否 | /templates/device.xlsx | 报表模板路径 |
| querySql | string | 否 | SELECT * FROM... | 查询SQL |
| description | string | 否 | 设备状态监控报表 | 报表描述 |
| isActive | boolean | 否 | true | 是否启用 |

#### 12.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 新创建的报表ID |
| reportCode | string | 必须 | 报表编码 |
| reportName | string | 必须 | 报表名称 |
| createdAt | string | 必须 | 创建时间 |

#### 12.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "创建成功",
  "data": {
    "id": 6,
    "reportCode": "device_status_report",
    "reportName": "设备状态报表",
    "createdAt": "2025-12-11 10:35:00"
  }
}
```

---

### 12.3 更新报表配置

#### 12.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/report-configs/{id}` |
| 请求方式 | `PUT` |
| 接口描述 | 更新报表配置 |
| 是否需要认证 | 是（需要管理员权限） |

#### 12.3.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1 | 路径参数：报表ID |
| reportName | string | 否 | 设备状态报表 | 报表名称 |
| reportTemplate | string | 否 | /templates/device.xlsx | 报表模板路径 |
| querySql | string | 否 | SELECT * FROM... | 查询SQL |
| description | string | 否 | 设备状态监控报表 | 报表描述 |
| isActive | boolean | 否 | true | 是否启用 |

#### 12.3.3 响应数据字段 (data: null)

无

#### 12.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "更新成功",
  "data": null
}
```

---

### 12.4 删除报表配置

#### 12.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/admin/report-configs/{id}` |
| 请求方式 | `DELETE` |
| 接口描述 | 删除指定报表配置 |
| 是否需要认证 | 是（需要管理员权限） |

#### 12.4.2 请求参数 (路径参数)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| id | number | 必须 | 报表ID |

#### 12.4.3 响应数据字段 (data: null)

无

#### 12.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "删除成功",
  "data": null
}
```

---

## 13. 设备端接口（供分布式机器调用）

### 设备身份识别说明

**核心原则：使用设备编码（device_code）作为唯一标识**

- **设备唯一标识**：`device_code`（设备编码），由系统分配，不可修改，作为设备的唯一身份标识
- **设备密钥**：`device_secret`（设备密钥），在创建设备时自动生成，用于设备认证
- **IP和端口**：`ip_address` 和 `port` 仅作为辅助信息，不作为设备标识（设备IP可能动态变化）

**设备认证流程：**
1. 管理员在后台添加设备（2.3接口） → 系统自动生成并返回 `device_code` 和 `device_secret`
2. 设备使用 `device_code` 和 `device_secret` 进行认证：
   - **HTTP接口**：在请求参数中提供 `device_code` 和 `device_secret`，或先调用13.0接口获取Token后使用Token认证
   - **WebSocket接口**：在连接URL参数中提供 `device_code` 和 `device_secret`，或在连接后发送认证消息
3. 推荐使用WebSocket长连接（14.3）建立持久连接，通过 `device_code` 和 `device_secret` 直接认证

---

### 13.0 设备认证登录

#### 13.0.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/auth/login` |
| 请求方式 | `POST` |
| 接口描述 | 设备通过设备编码和设备密钥进行认证，获取访问Token。设备在调用其他设备端接口前必须先调用此接口获取Token |
| 是否需要认证 | 否 |

#### 13.0.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（唯一标识） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（在添加设备时由系统生成） |

#### 13.0.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| accessToken | string | 必须 | 设备访问令牌 |
| refreshToken | string | 必须 | 设备刷新令牌 |
| tokenType | string | 必须 | 令牌类型（Bearer） |
| expiresIn | number | 必须 | 过期时间（秒），默认7200秒 |
| deviceId | number | 必须 | 设备ID |
| deviceCode | string | 必须 | 设备编码 |

#### 13.0.4 响应数据样例

```json
{
  "code": 1,
  "msg": "设备认证成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "tokenType": "Bearer",
    "expiresIn": 7200,
    "deviceId": 1,
    "deviceCode": "DEV-001"
  }
}
```

**说明：**
- 设备在首次连接服务器时，需要调用此接口进行认证
- 认证成功后，需要在后续所有设备端接口请求的Header中携带：`Authorization: Bearer {accessToken}`
- Token过期后，可以使用refreshToken刷新或重新调用此接口认证
- 设备密钥（deviceSecret）由管理员在添加设备时从系统获取，请妥善保管

---

### 13.1 设备心跳

**注意：推荐使用WebSocket长连接（14.3接口），通过WebSocket消息发送心跳，而非HTTP接口**

#### 13.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/heartbeat` |
| 请求方式 | `POST` |
| 接口描述 | 设备向服务器发送心跳保活信号（HTTP方式）。**推荐使用WebSocket长连接（14.3接口）通过消息发送心跳** |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.1.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |
| timestamp | number | 必须 | 1702281600000 | 时间戳（毫秒） |
| extraData | object | 否 | {...} | 额外数据 |

**认证说明：**
- 必须提供 `device_code` 和 `device_secret` 作为认证凭证
- 或者使用Token认证：在请求头中携带 `Authorization: Bearer {accessToken}`（通过13.0接口获取）

#### 13.1.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| received | boolean | 必须 | 是否接收成功 |
| serverTime | number | 必须 | 服务器时间戳 |
| nextHeartbeatInterval | number | 必须 | 下次心跳间隔（秒） |

#### 13.1.4 响应数据样例

```json
{
  "code": 1,
  "msg": "心跳接收成功",
  "data": {
    "received": true,
    "serverTime": 1702281605000,
    "nextHeartbeatInterval": 60
  }
}
```

---

### 13.2 上报设备状态

#### 13.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/status` |
| 请求方式 | `POST` |
| 接口描述 | 设备上报实时状态数据（HTTP方式）。**推荐使用WebSocket长连接（14.3接口）通过消息上报状态** |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.2.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |
| statusType | string | 必须 | access | 状态类型（门禁场景） |
| doorStatus | string | 否 | open | 门状态：open/closed |
| doorControllerStatus | string | 否 | normal | 门禁控制器状态 |
| customData | object | 否 | {...} | 自定义数据（门禁相关） |
| reportTime | string | 必须 | 2025-12-11 11:00:00 | 上报时间 |

#### 13.2.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| received | boolean | 必须 | 是否接收成功 |
| statusId | number | 必须 | 状态记录ID |

#### 13.2.4 响应数据样例

```json
{
  "code": 1,
  "msg": "状态上报成功",
  "data": {
    "received": true,
    "statusId": 10001
  }
}
```

---

### 13.3 获取待执行命令

#### 13.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/commands/pending` |
| 请求方式 | `GET` |
| 接口描述 | **已弃用（HTTP）**：设备应使用WebSocket接收命令，HTTP轮询仅作兼容性保留，不推荐用于门禁场景。 |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.3.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |

#### 13.3.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| commandLogId | number | 必须 | 命令日志ID |
| commandCode | string | 必须 | 命令编码 |
| commandParams | object | 否 | 命令参数 |
| executeTime | string | 必须 | 执行时间 |

#### 13.3.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "commandLogId": 1001,
      "commandCode": "restart",
      "commandParams": {
        "delay": 10
      },
      "executeTime": "2025-12-11 10:45:00"
    }
  ]
}
```

---

### 13.4 上报命令执行结果

#### 13.4.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/commands/{id}/result` |
| 请求方式 | `PUT` |
| 接口描述 | 设备上报命令执行结果 |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.4.2 请求参数 (路径参数 & application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| id | number | 必须 | 1001 | 路径参数：命令日志ID |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |
| status | string | 必须 | success | 执行状态：success/failed |
| responseData | object | 否 | {...} | 响应数据 |
| errorMessage | string | 否 | null | 错误信息 |
| duration | number | 必须 | 15000 | 执行耗时（毫秒） |

#### 13.4.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| received | boolean | 必须 | 是否接收成功 |
| commandLogId | number | 必须 | 命令日志ID |

#### 13.4.4 响应数据样例

```json
{
  "code": 1,
  "msg": "命令结果已接收",
  "data": {
    "received": true,
    "commandLogId": 1001
  }
}
```

---

### 13.5 获取配置信息

#### 13.5.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/config` |
| 请求方式 | `GET` |
| 接口描述 | 设备拉取服务器配置信息（HTTP方式）。**推荐使用WebSocket长连接（14.3接口）通过消息获取配置** |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.5.2 请求参数 (queryString)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |

#### 13.5.3 响应数据字段 (data: object[])

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| configKey | string | 必须 | 配置键 |
| configValue | string | 必须 | 配置值 |
| configType | string | 必须 | 配置类型：string/number/boolean/json |
| description | string | 否 | 配置说明 |

#### 13.5.4 响应数据样例

```json
{
  "code": 1,
  "msg": "获取成功",
  "data": [
    {
      "configKey": "heartbeat_interval",
      "configValue": "60",
      "configType": "number",
      "description": "心跳间隔（秒）"
    },
    {
      "configKey": "report_interval",
      "configValue": "300",
      "configType": "number",
      "description": "状态上报间隔（秒）"
    }
  ]
}
```

---

### 13.6 确认配置同步

#### 13.6.1 基本信息

| 属性 | 值 |
| --- | --- |
| 请求路径 | `/device/config/confirm` |
| 请求方式 | `POST` |
| 接口描述 | 设备确认配置已同步到本地 |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 13.6.2 请求参数 (application/json)

| 参数名 | 类型 | 是否必须 | 示例 | 备注 |
| ------ | ---- | -------- | ---- | ---- |
| deviceCode | string | 必须 | DEV-001 | 设备编码（认证凭证） |
| deviceSecret | string | 必须 | a1b2c3d4e5f6... | 设备密钥（认证凭证） |
| configKeys | string[] | 必须 | ["heartbeat_interval", "report_interval"] | 已同步的配置键列表 |

#### 13.6.3 响应数据字段 (data: object)

| 参数名 | 类型 | 是否必须 | 备注 |
| ------ | ---- | -------- | ---- |
| confirmed | boolean | 必须 | 是否确认成功 |
| confirmedCount | number | 必须 | 已确认配置项数量 |

#### 13.6.4 响应数据样例

```json
{
  "code": 1,
  "msg": "配置同步确认成功",
  "data": {
    "confirmed": true,
    "confirmedCount": 2
  }
}
```

---

## 14. WebSocket接口

### 14.1 实时监控WebSocket

#### 14.1.1 基本信息

| 属性 | 值 |
| --- | --- |
| 连接路径 | `/ws/monitor` |
| 协议 | WebSocket |
| 接口描述 | 实时推送设备状态变化 |
| 是否需要认证 | 是（通过Token参数） |

#### 14.1.2 连接方式

```
ws://server-address/ws/monitor?token=YOUR_ACCESS_TOKEN
```

#### 14.1.3 推送消息格式

**设备状态变化消息**

```json
{
  "type": "device_status_change",
  "timestamp": 1702281600000,
  "data": {
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "onlineStatus": 0,
    "previousStatus": 1,
    "changeTime": "2025-12-11 11:00:00"
  }
}
```

**设备状态更新消息**

```json
{
  "type": "device_status_update",
  "timestamp": 1702281600000,
  "data": {
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "cpuUsage": 85.2,
    "memoryUsage": 72.5,
    "diskUsage": 52.3,
    "reportTime": "2025-12-11 11:00:00"
  }
}
```

---

### 14.2 告警推送WebSocket

#### 14.2.1 基本信息

| 属性 | 值 |
| --- | --- |
| 连接路径 | `/ws/alerts` |
| 协议 | WebSocket |
| 接口描述 | 实时推送告警通知 |
| 是否需要认证 | 是（通过Token参数） |

#### 14.2.2 连接方式

```
ws://server-address/ws/alerts?token=YOUR_ACCESS_TOKEN
```

#### 14.2.3 推送消息格式

```json
{
  "type": "new_alert",
  "timestamp": 1702281600000,
  "data": {
    "alertId": 1,
    "alertNo": "ALT-20251211-001",
    "deviceId": 1,
    "deviceName": "生产服务器01",
    "alertLevel": "error",
    "alertType": "device_offline",
    "alertMessage": "设备 生产服务器01 已离线超过5分钟",
    "alertTime": "2025-12-11 11:00:00"
  }
}
```

---

### 14.3 设备WebSocket长连接（推荐）

#### 14.3.1 基本信息

| 属性 | 值 |
| --- | --- |
| 连接路径 | `/device/ws` |
| 协议 | WebSocket |
| 接口描述 | 设备与服务器建立WebSocket长连接，实现双向实时通信。支持心跳保活、状态上报、命令接收等功能。**这是推荐的设备通信方式，替代HTTP轮询** |
| 是否需要认证 | 是（必须提供 device_code 和 device_secret） |

#### 14.3.2 连接方式

**方式一：URL参数传递认证凭证（推荐）**

```
ws://server-address/device/ws?deviceCode=DEV-001&deviceSecret=your_device_secret
```

**方式二：连接后发送认证消息**

```
ws://server-address/device/ws?deviceCode=DEV-001
```

连接成功后，立即发送认证消息（必须包含 device_code 和 device_secret）：

```json
{
  "type": "auth",
  "data": {
    "deviceCode": "DEV-001",
    "deviceSecret": "your_device_secret",
    "timestamp": 1702281600000
  }
}
```

**重要说明：**
- WebSocket连接必须提供 `device_code` 和 `device_secret` 作为认证凭证
- 可以在URL参数中直接传递，或在连接后通过认证消息发送
- 服务器会验证设备凭证，验证失败将立即关闭连接

#### 14.3.3 心跳机制

**重要：设备在WebSocket连接建立并认证成功后，必须立即启动心跳定时器，定时发送心跳包。**

**心跳要求：**
- **启动时机**：设备收到 `auth_ack` 认证成功消息后，必须立即启动心跳定时器
- **发送频率**：每30-60秒发送一次心跳包（默认60秒，服务器可通过 `heartbeat_ack` 响应中的 `nextHeartbeatInterval` 调整）
- **作用**：
  - 保持连接活跃，防止服务器因超时断开连接
  - 更新设备在线状态和最后心跳时间
  - 记录心跳历史，用于监控设备连接稳定性
- **停止时机**：连接断开时（`onclose` 事件）必须停止心跳定时器

**心跳消息格式（设备 → 服务器）：**

```json
{
  "type": "heartbeat",
  "data": {
    "deviceCode": "DEV-001",
    "timestamp": 1702281600000,
    "extraData": {
      "version": "1.0.0",
      "uptime": 259200
    }
  }
}
```

**心跳响应格式（服务器 → 设备）：**

```json
{
  "type": "heartbeat_ack",
  "data": {
    "received": true,
    "serverTime": 1702281605000,
    "nextHeartbeatInterval": 60
  },
  "timestamp": 1702281605000
}
```

**认证响应格式（服务器 → 设备）：**

认证成功后，服务器会发送 `auth_ack` 消息，设备收到后**必须立即启动心跳定时器**：

```json
{
  "type": "auth_ack",
  "data": {
    "authenticated": true,
    "heartbeatInterval": 60
  },
  "timestamp": 1702281600000
}
```

- `authenticated`: 认证是否成功
- `heartbeatInterval`: 建议的心跳间隔（秒），设备应使用此值启动心跳定时器

#### 14.3.4 状态上报（设备 → 服务器）

设备可以定时或事件触发上报状态信息：

**状态上报消息格式：**

```json
{
  "type": "status_report",
  "data": {
    "deviceCode": "DEV-001",
    "statusType": "access",
    "doorStatus": "open",
    "doorControllerStatus": "normal",
    "customData": {
      "lastOpenEventId": 12345,
      "openDurationSeconds": 12
    },
    "reportTime": "2025-12-11 11:00:00"
  },
  "timestamp": 1702281600000
}
```

**状态上报响应格式（服务器 → 设备）：**

```json
{
  "type": "status_report_ack",
  "data": {
    "received": true,
    "statusId": 10001
  },
  "timestamp": 1702281601000
}
```

#### 14.3.5 命令接收（服务器 → 设备）

服务器可以向设备推送控制命令：

**命令推送消息格式（服务器 → 设备）：**

```json
{
  "type": "command",
  "data": {
    "commandId": "CMD_20251213_001",
    "commandLogId": 1001,
    "commandCode": "open_door",
    "commandName": "开门",
    "commandParams": {
      "duration": 5,            // 持续时间（秒），可选
      "reason": "authorized_access"
    },
    "executeTime": "2025-12-13 10:45:00"
  },
  "timestamp": 1702281600000
}
```

**命令接收确认（设备 → 服务器）：**

```json
{
  "type": "command_received",
  "data": {
    "commandLogId": 1001,
    "received": true
  },
  "timestamp": 1702281601000
}
```

**命令执行结果上报（设备 → 服务器）：**

```json
{
  "type": "command_result",
  "data": {
    "commandLogId": 1001,
    "deviceCode": "DEV-001",
    "status": "success",
    "responseData": {
      "message": "门已打开",
      "openDurationSeconds": 5
    },
    "errorMessage": null,
    "duration": 5000
  },
  "timestamp": 1702281615000
}
```

#### 14.3.6 配置同步（服务器 → 设备）

服务器可以推送配置更新：

**配置推送消息格式（服务器 → 设备）：**

```json
{
  "type": "config_update",
  "data": {
    "deviceCode": "DEV-001",
    "configs": [
      {
        "configKey": "heartbeat_interval",
        "configValue": "60",
        "configType": "number",
        "description": "心跳间隔（秒）"
      }
    ]
  },
  "timestamp": 1702281600000
}
```

**配置同步确认（设备 → 服务器）：**

```json
{
  "type": "config_sync_confirm",
  "data": {
    "deviceCode": "DEV-001",
    "configKeys": ["heartbeat_interval", "report_interval"],
    "confirmed": true
  },
  "timestamp": 1702281605000
}
```
 
---

### 14.3.6 设备上报告警（设备 → 服务器，WebSocket）

#### 14.3.6.1 基本信息

| 属性 | 值 |
| --- | --- |
| 消息类型 | `alert_report` |
| 方向 | 设备 → 服务器（WebSocket 消息） |
| 接口描述 | 设备在本地检测到告警后，通过 WebSocket 上报告警，服务端收到后入库（`alert_record`）并返回确认 ack；同时可推送到前端告警通道。 |
| 是否需要鉴权 | 是（连接建立时使用 `deviceCode`/`deviceSecret` 或在连接后认证） |

#### 14.3.6.2 消息格式（设备 → 服务器）

```json
{
  "type": "alert_report",
  "data": {
    "deviceCode": "DEV-001",
    "alertType": "door_not_closed_timeout",
    "ruleCode": "door_not_closed_timeout",   // 可选
    "severity": "error",                     // info/warning/error/critical
    "alertMessage": "设备 DEV-001 门未关闭超过30秒",
    "alertData": {                           // 可选结构化数据
      "doorStatus": "open",
      "durationSeconds": 35
    },
    "alertTime": "2026-01-02 19:00:00"
  },
  "timestamp": 1700000000000
}
```

字段说明：
- `deviceCode`：设备编码（必填）。
- `alertType`：告警类型/编码（必填，或以 `ruleCode` 代替）。
- `ruleCode`：设备本地使用的规则编码（可选）。
- `severity`：告警级别。
- `alertMessage`：展示文本。
- `alertData`：可选 JSON，写入 `alert_record.alert_data`。
- `alertTime`：设备端事件时间（建议提供）。

#### 14.3.6.3 服务器确认（服务器 → 设备）

成功入库后服务器返回：

```json
{
  "type": "alert_ack",
  "data": {
    "received": true,
    "alertId": 12345,
    "status": "stored"
  },
  "timestamp": 1700000000500
}
```

失败示例（参数校验失败）：

```json
{
  "type": "error",
  "data": {
    "errorCode": "INVALID_PAYLOAD",
    "errorMessage": "alertType 不能为空",
    "deviceCode": "DEV-001"
  },
  "timestamp": 1700000000600
}
```

#### 14.3.6.4 服务端处理与入库（实现建议）

- 服务端需校验设备会话已鉴权或校验 `deviceCode`/`deviceSecret`，校验必填字段后将告警写入 `alert_record` 表，字段映射参考 `distributed_monitor.sql` 中 `alert_record` 表：
  - `device_id`：通过 `device_code` 解析得到；
  - `alert_no`：服务端生成的唯一告警编号；
  - `alert_type`、`alert_message`、`alert_data`、`alert_time`、`status`（初始为 `pending`）等列。
- 可选：如果设备提供 `ruleCode`，服务端可尝试关联 `alert_rule` 表设置 `rule_id`。
- 建议对告警进行去重/降噪与限流，防止设备故障导致数据洪峰。

#### 14.3.6.5 推送到前端

服务器在入库后应将新告警推送到前端告警通道（`/ws/alerts`）使用 `new_alert` 消息（参考 14.2 的 `new_alert` 格式）。

---

#### 14.3.7 错误通知（服务器 → 设备）

服务器可以向设备发送错误或警告通知：

```json
{
  "type": "error",
  "data": {
    "errorCode": "CONFIG_INVALID",
    "errorMessage": "配置项 heartbeat_interval 的值无效",
    "deviceCode": "DEV-001"
  },
  "timestamp": 1702281600000
}
```

#### 14.3.8 连接管理

**连接建立后的流程：**

1. **建立连接**：设备通过WebSocket连接到服务器
2. **认证**：发送认证消息（如果URL参数中未提供认证信息）
3. **接收认证响应**：收到 `auth_ack` 消息后，表示认证成功
4. **启动心跳定时器**：**必须立即启动心跳定时器，开始定时发送心跳包**
5. **开始业务通信**：可以开始发送状态上报、接收命令等

**连接断开处理：**

当连接断开时，设备应该：
1. **停止心跳定时器**：检测到连接断开（onclose事件）后，必须立即停止心跳定时器
2. 使用指数退避算法自动重连：
   - 第1次：立即重连
   - 第2次：等待1秒后重连
   - 第3次：等待2秒后重连
   - 第4次：等待4秒后重连
   - 第5次：等待8秒后重连
   - 最大等待时间：60秒
3. 重连成功后重新发送认证消息
4. **重新启动心跳定时器**：收到 `auth_ack` 后立即重新启动心跳定时器
5. 恢复状态上报等其他业务功能

**会话保持：**

- WebSocket连接建立后，服务器会为设备分配一个会话ID（session_id）
- 会话ID会与设备的 `device_code` 关联
- 设备可以通过会话ID维持与服务器的关联状态
- 连接断开后，会话会在一段时间后自动清理

#### 14.3.9 消息类型汇总

| 消息类型 | 方向 | 说明 |
| -------- | ---- | ---- |
| `auth` | 设备 → 服务器 | 设备认证消息 |
| `auth_ack` | 服务器 → 设备 | 认证响应（包含心跳间隔建议，设备收到后必须立即启动心跳定时器） |
| `heartbeat` | 设备 → 服务器 | 心跳消息（每30-60秒，认证成功后必须定时发送） |
| `heartbeat_ack` | 服务器 → 设备 | 心跳响应（包含下次心跳间隔建议） |
| `status_report` | 设备 → 服务器 | 状态上报 |
| `status_report_ack` | 服务器 → 设备 | 状态上报响应 |
| `command` | 服务器 → 设备 | 控制命令推送 |
| `command_received` | 设备 → 服务器 | 命令接收确认 |
| `command_result` | 设备 → 服务器 | 命令执行结果 |
| `config_update` | 服务器 → 设备 | 配置更新推送 |
| `config_sync_confirm` | 设备 → 服务器 | 配置同步确认 |
| `error` | 服务器 → 设备 | 错误通知 |
| `ping` | 双向 | WebSocket ping（用于保活） |
| `pong` | 双向 | WebSocket pong（用于保活） |

#### 14.3.10 设备端实现示例（JavaScript）

```javascript
class DeviceWebSocketClient {
  constructor(serverUrl, deviceCode, deviceSecret) {
    this.serverUrl = serverUrl;
    this.deviceCode = deviceCode;
    this.deviceSecret = deviceSecret;
    this.ws = null;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = 10;
    this.reconnectDelay = 1000;
    this.heartbeatInterval = null;
    this.heartbeatTimer = 60000; // 60秒
    this.isAuthenticated = false;
  }

  connect() {
    // 直接使用 device_code 和 device_secret 连接WebSocket
    const wsUrl = `${this.serverUrl.replace('http', 'ws')}/device/ws?deviceCode=${this.deviceCode}&deviceSecret=${this.deviceSecret}`;
    this.ws = new WebSocket(wsUrl);

    this.ws.onopen = () => {
      console.log('WebSocket连接已建立');
      this.reconnectAttempts = 0;
      // 注意：如果URL参数中已包含认证信息，服务器会在连接成功后立即发送 auth_ack
      // 如果URL参数中没有认证信息，需要先发送 auth 消息，然后等待 auth_ack
      // 无论哪种方式，都必须在收到 auth_ack 后再启动心跳定时器
      // 因此这里不立即启动心跳，等待 auth_ack 消息
    };

    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleMessage(message);
    };

    this.ws.onerror = (error) => {
      console.error('WebSocket错误：', error);
    };

    this.ws.onclose = () => {
      console.log('WebSocket连接已关闭');
      this.stopHeartbeat();
      this.isAuthenticated = false;
      this.reconnect();
    };
  }

  handleMessage(message) {
    switch (message.type) {
      case 'auth_ack':
        this.isAuthenticated = true;
        console.log('设备认证成功');
        // 认证成功后，必须立即启动心跳定时器
        // 如果服务器返回了心跳间隔建议，使用服务器建议的值
        if (message.data.heartbeatInterval) {
          this.heartbeatTimer = message.data.heartbeatInterval * 1000;
        }
        this.startHeartbeat();
        break;
      case 'heartbeat_ack':
        if (message.data.nextHeartbeatInterval) {
          this.heartbeatTimer = message.data.nextHeartbeatInterval * 1000;
        }
        break;
      case 'command':
        this.handleCommand(message.data);
        break;
      case 'config_update':
        this.handleConfigUpdate(message.data);
        break;
      case 'error':
        console.error('服务器错误：', message.data.errorMessage);
        break;
      default:
        console.log('收到消息：', message);
    }
  }

  startHeartbeat() {
    this.heartbeatInterval = setInterval(() => {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.send({
          type: 'heartbeat',
          data: {
            deviceCode: this.deviceCode,
            timestamp: Date.now()
          },
          timestamp: Date.now()
        });
      }
    }, this.heartbeatTimer);
  }

  stopHeartbeat() {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
      this.heartbeatInterval = null;
    }
  }

  sendStatusReport(statusData) {
    this.send({
      type: 'status_report',
      data: {
        deviceCode: this.deviceCode,
        ...statusData
      },
      timestamp: Date.now()
    });
  }

  async reconnect() {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('达到最大重连次数，停止重连');
      return;
    }

    const delay = Math.min(this.reconnectDelay * Math.pow(2, this.reconnectAttempts), 60000);
    console.log(`${delay}ms后尝试重连... (${this.reconnectAttempts + 1}/${this.maxReconnectAttempts})`);

    setTimeout(() => {
      this.reconnectAttempts++;
      // 直接重连，使用 device_code 和 device_secret
      this.connect();
    }, delay);
  }

  send(message) {
    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify(message));
    }
  }

  handleCommand(commandData) {
    console.log('收到命令：', commandData);
    this.send({
      type: 'command_received',
      data: {
        commandLogId: commandData.commandLogId,
        received: true
      },
      timestamp: Date.now()
    });

    this.executeCommand(commandData).then(result => {
      this.send({
        type: 'command_result',
        data: {
          commandLogId: commandData.commandLogId,
          deviceCode: this.deviceCode,
          status: result.success ? 'success' : 'failed',
          responseData: result.data,
          errorMessage: result.error,
          duration: result.duration
        },
        timestamp: Date.now()
      });
    });
  }

  async executeCommand(commandData) {
    const startTime = Date.now();
    try {
      // 执行命令逻辑
      return {
        success: true,
        data: { message: '命令执行成功' },
        duration: Date.now() - startTime
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        duration: Date.now() - startTime
      };
    }
  }

  handleConfigUpdate(configData) {
    console.log('收到配置更新：', configData);
    // 应用配置...
    this.send({
      type: 'config_sync_confirm',
      data: {
        deviceCode: this.deviceCode,
        configKeys: configData.configs.map(c => c.configKey),
        confirmed: true
      },
      timestamp: Date.now()
    });
  }
}

// 使用示例
// device_secret 是在注册设备时由系统返回的密钥
const client = new DeviceWebSocketClient(
  'http://localhost:8080/api',
  'DEV-001',
  'your_device_secret'  // 从注册设备接口（2.3）获取
);

// 直接连接，使用 device_code 和 device_secret 认证
client.connect();

// 定时上报状态
setInterval(() => {
  client.sendStatusReport({
    statusType: 'access',
    doorStatus: 'closed',
    doorControllerStatus: 'normal',
    reportTime: new Date().toISOString()
  });
}, 60000);
```

#### 14.3.11 最佳实践

1. **使用WebSocket长连接**：优先使用WebSocket长连接而非HTTP轮询
2. **心跳保活（必须）**：
   - 设备在WebSocket连接建立并认证成功后，**必须立即启动心跳定时器**
   - 每30-60秒发送心跳包，保持连接活跃
   - 连接断开时**必须停止心跳定时器**，避免资源浪费
   - 重连成功后**必须重新启动心跳定时器**
3. **自动重连**：连接断开时使用指数退避算法自动重连
4. **状态上报**：定时或事件触发上报设备状态（可选，与心跳分开）
5. **错误处理**：正确处理服务器发送的错误通知
6. **会话保持**：通过WebSocket维持设备与服务器的关联状态
7. **身份识别**：始终使用 `device_code` 作为设备标识，不依赖IP地址

**心跳与状态上报的区别：**
- **心跳（heartbeat）**：必须定时发送，用于保活和在线状态检测，频率较高（30-60秒）
-- **状态上报（status_report）**：用于上报门禁设备的业务状态（门状态、控制器状态等），频率按业务需要设置（通常事件触发或定期上报）。

---

## 错误码说明

| 错误码 | HTTP状态码 | 说明 |
| ------ | ---------- | ---- |
| 1 | 200 | 成功 |
| 0 | 200 | 业务失败 |
| 400 | 400 | 请求参数错误 |
| 401 | 401 | 未认证或Token无效 |
| 403 | 403 | 权限不足 |
| 404 | 404 | 资源不存在 |
| 409 | 409 | 资源冲突 |
| 500 | 500 | 服务器内部错误 |

---

## 接口调用示例

### 前端调用示例（JavaScript）

```javascript
// API基础配置
const API_BASE_URL = 'http://localhost:8080/api';
let accessToken = '';

// 通用请求函数
async function apiRequest(url, options = {}) {
  const headers = {
    'Content-Type': 'application/json',
    ...options.headers,
  };
  
  if (accessToken) {
    headers['Authorization'] = `Bearer ${accessToken}`;
  }
  
  const response = await fetch(`${API_BASE_URL}${url}`, {
    ...options,
    headers,
  });
  
  return await response.json();
}

// 用户登录
async function login(username, password) {
  const data = await apiRequest('/auth/login', {
    method: 'POST',
    body: JSON.stringify({ username, password }),
  });
  
  if (data.code === 1) {
    accessToken = data.data.accessToken;
    localStorage.setItem('accessToken', accessToken);
  }
  
  return data;
}

// 获取设备列表
async function getDevices(params) {
  const query = new URLSearchParams(params).toString();
  return await apiRequest(`/devices?${query}`);
}

// 发送控制命令
async function sendCommand(deviceId, commandCode, commandParams) {
  return await apiRequest(`/devices/${deviceId}/commands`, {
    method: 'POST',
    body: JSON.stringify({ commandCode, commandParams }),
  });
}

// WebSocket连接示例
function connectWebSocket() {
  const token = localStorage.getItem('accessToken');
  const ws = new WebSocket(`ws://localhost:8080/ws/monitor?token=${token}`);
  
  ws.onopen = () => {
    console.log('WebSocket连接已建立');
  };
  
  ws.onmessage = (event) => {
    const message = JSON.parse(event.data);
    console.log('收到推送消息：', message);
    
    if (message.type === 'device_status_change') {
      // 处理设备状态变化
      handleDeviceStatusChange(message.data);
    }
  };
  
  ws.onerror = (error) => {
    console.error('WebSocket错误：', error);
  };
  
  ws.onclose = () => {
    console.log('WebSocket连接已关闭');
    // 重连逻辑
    setTimeout(connectWebSocket, 5000);
  };
  
  return ws;
}
```

### 设备端调用示例（Python）

```python
import requests
import time
import json

class DeviceClient:
    def __init__(self, server_url, device_code, device_token):
        self.server_url = server_url
        self.device_code = device_code
        self.headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {device_token}'
        }
    
    def send_heartbeat(self):
        """发送心跳"""
        url = f'{self.server_url}/device/heartbeat'
        data = {
            'deviceCode': self.device_code,
            'timestamp': int(time.time() * 1000)
        }
        response = requests.post(url, json=data, headers=self.headers)
        return response.json()
    
    def report_status(self, status_data):
        """上报状态"""
        url = f'{self.server_url}/device/status'
        data = {
            'deviceCode': self.device_code,
            'statusType': 'system',
            'reportTime': time.strftime('%Y-%m-%d %H:%M:%S'),
            **status_data
        }
        response = requests.post(url, json=data, headers=self.headers)
        return response.json()
    
    def get_pending_commands(self):
        """获取待执行命令"""
        url = f'{self.server_url}/device/commands/pending'
        params = {'deviceCode': self.device_code}
        response = requests.get(url, params=params, headers=self.headers)
        return response.json()
    
    def report_command_result(self, command_log_id, status, response_data=None, error_message=None, duration=0):
        """上报命令执行结果"""
        url = f'{self.server_url}/device/commands/{command_log_id}/result'
        data = {
            'deviceCode': self.device_code,
            'status': status,
            'responseData': response_data,
            'errorMessage': error_message,
            'duration': duration
        }
        response = requests.put(url, json=data, headers=self.headers)
        return response.json()

# 使用示例
if __name__ == '__main__':
    client = DeviceClient(
        server_url='http://localhost:8080/api',
        device_code='DEV-001',
        device_token='your_device_token_here'
    )
    
    # 发送心跳
    heartbeat_result = client.send_heartbeat()
    print('心跳结果:', heartbeat_result)
    
    # 上报状态
    status_result = client.report_status({
    'doorStatus': 'closed',
    'doorControllerStatus': 'normal'
    })
    print('状态上报结果:', status_result)
    
    # 获取待执行命令
    commands = client.get_pending_commands()
    print('待执行命令:', commands)
```

---

## 附录：数据字典

### 设备状态枚举

| 值 | 说明 |
| -- | ---- |
| online | 在线 |
| offline | 离线 |
| fault | 故障 |
| maintain | 维护 |

### 命令执行状态枚举

| 值 | 说明 |
| -- | ---- |
| pending | 待执行 |
| sending | 发送中 |
| success | 执行成功 |
| failed | 执行失败 |
| timeout | 执行超时 |

### 告警级别枚举

| 值 | 说明 |
| -- | ---- |
| info | 信息 |
| warning | 警告 |
| error | 错误 |
| critical | 严重 |

### 告警处理状态枚举

| 值 | 说明 |
| -- | ---- |
| pending | 待处理 |
| confirmed | 已确认 |
| resolved | 已解决 |
| ignored | 已忽略 |

